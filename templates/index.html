<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Churn Prediction Dashboard</title>

  <!-- CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/style.css') }}" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <!-- ================= NAVBAR ================= -->
  <div class="navbar">
    <a href="#home">Home</a>
    <a href="#about">About</a>
    <a href="#predict">Predict</a>
    <a href="#stats">Statistics</a>
    <a href="#about-us">About Us</a>
  </div>

  <!-- ================= HOME SECTION ================= -->
  <section id="home" class="section">
    <img class="hero-img" src="{{ url_for('static', filename='assets/images/dashboard.png') }}" alt="Dashboard Image" />
    <h1>Customer Churn Prediction System</h1>
    <p>AI-powered analytics to predict customer churn with precision.</p>
  </section>
  <hr />
  <hr />
  <!-- ================= ABOUT SECTION ================= -->
  <section id="about" class="section about">
    <div class="about-images">
      <div class="about-text">
        <p>
          This project is an end-to-end Machine Learning powered web
          application designed to predict customer churn and present insights
          through a modern, professional dashboard interface. It combines data
          science, backend development, and frontend design into one complete
          solution.
        </p>

        <p>
          The main goal of this system is to help businesses identify
          customers who are likely to leave (churn) and take proactive actions
          to retain them.
        </p>

        <h3>游댳 What This Project Does</h3>

        <ul>
          <li>
            Predicts whether a customer will exit a service using a trained
            Machine Learning model.
          </li>
          <li>Shows the churn probability in percentage form.</li>
          <li>Classifies customers into:</li>
          <ul>
            <li>游댮 High Risk</li>
            <li>游리 Medium Risk</li>
            <li>游릭 Low Risk</li>
          </ul>
          <li>Stores each prediction in a database.</li>
          <li>Displays real-time statistics in a single-page dashboard.</li>
          <li>Visualizes prediction trends using charts.</li>
        </ul>
      </div>
      <img src="{{ url_for('static', filename='assets/images/churn.png') }}" alt="Churn Prediction" />
    </div>
  </section>

  <!-- ================= PREDICTION FORM ================= -->
  <section id="predict" class="section">
    <h2>Predict Customer Churn</h2>
    <p class="form-hint">Enter values within the acceptable ranges</p>

    <form id="predictionForm">
      <input type="number" id="CreditScore" placeholder="Credit Score (350 - 900)"
        title="Credit Score must be between 350 and 900" required />
      <input type="number" id="Age" placeholder="Age (18 - 110)" title="Age must be between 18 and 110" required />
      <input type="number" id="Tenure" placeholder="Tenure (0 - 10)" title="Tenure must be between 0 and 10" required />
      <input type="number" id="Balance" placeholder="Balance (0 - 300000)" title="Balance must be between 0 and 300000"
        required />
      <input type="number" id="Product" placeholder="Number of Products (1 - 6)"
        title="Number of Products must be between 1 and 6" required />
      <input type="number" id="EstimatedSalary" placeholder="Estimated Salary (5000 - 3000000)"
        title="Estimated Salary must be between 5000 and 3000000" required />

      <select id="Gender" required>
        <option value="">Select Gender</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
      </select>

      <select id="Country" required>
        <option value="">Select Country</option>
        <option value="France">France</option>
        <option value="Germany">Germany</option>
        <option value="Spain">Spain</option>
      </select>

      <select id="HasCrCard" required>
        <option value="">Select Credit Card Status</option>
        <option value="1">Has Credit Card</option>
        <option value="0">No Credit Card</option>
      </select>

      <select id="IsActiveMember" required>
        <option value="">Select Member Status</option>
        <option value="1">Active Member</option>
        <option value="0">Not Active</option>
      </select>

      <button type="submit" id="predictBtn">Predict Now</button>
    </form>
  </section>

  <!-- ================= STATS SECTION ================= -->
  <section id="stats" class="section">
    <h2>Prediction Statistics</h2>

    <div class="chart-wrapper">
      <canvas id="riskChart"></canvas>
    </div>

    <!-- Latest Prediction Result -->
    <div class="latest-prediction" id="predictionResult" style="display: none">
      <h3>Latest Prediction Result</h3>
      <div class="prediction-result">
        <div class="result-card">
          <span class="result-label">Churn Probability:</span>
          <span class="result-value" id="probabilityValue">-</span>
        </div>
        <div class="result-card" id="riskCard">
          <span class="result-label">Risk Level:</span>
          <span class="result-value" id="riskValue"> - </span>
        </div>
      </div>
      <button id="predictAnotherBtn" class="predict-another-btn">
        Predict Another
      </button>
    </div>

    <div class="stats-info">
      <p>Total Predictions: <span id="totalCount">0</span></p>
      <p>High Risk: <span id="highCount">0</span></p>
      <p>Medium Risk: <span id="mediumCount">0</span></p>
      <p>Low Risk: <span id="lowCount">0</span></p>
    </div>
  </section>

  <!-- ================= FOOTER ================= -->
  <footer id="about-us" class="section">
    <div class="about-us-content">
      <h2>About Us</h2>

      <p>
        This Project is done by Final Year Students of Computer Science and
        Engineering And Data Science at G Pulla Reddy Engineering College
      </p>

      <h3>Team Members</h3>
      <ul class="team-list">
        <li><strong>K Rajkumar</strong> - 229X1A32B8</li>
        <li><strong>A Eswar Prasad</strong> - 239X5A32C9</li>
        <li><strong>A Harikishan Reddy</strong> - 239X5A32D1</li>
      </ul>

      <h3>Guided By</h3>
      <p><strong>Sri. Y. Shiva Kumar</strong> - Assistant Professor</p>

      <hr />
      <p style="font-size: 0.9rem; margin-top: 20px">
        춸 2026 Churn Prediction AI Dashboard | Developed by Raj Kumar
      </p>
    </div>
  </footer>

  <!-- ================= CHART SCRIPT ================= -->
  <script>
    // ============================================
    // BACKEND CONFIGURATION
    // ============================================
    // Change this to your deployed backend URL
    const BACKEND_URL = localStorage.getItem("backendUrl") || null;
    // const BACKEND_URL = "https://your-railway-app.railway.app";
    // const BACKEND_URL = "https://your-render-app.onrender.com";

    const USE_BACKEND = BACKEND_URL !== null;

    let chartInstance = null;
    let predictions = [];

    // Load predictions from localStorage on page load
    function loadPredictionsFromStorage() {
      const stored = localStorage.getItem("churnPredictions");
      if (stored) {
        predictions = JSON.parse(stored);
      }
    }

    // Save predictions to localStorage
    function savePredictionsToStorage() {
      localStorage.setItem("churnPredictions", JSON.stringify(predictions));
    }

    // Validation ranges
    const validationRanges = {
      CreditScore: { min: 350, max: 900, label: "Credit Score" },
      Age: { min: 18, max: 110, label: "Age" },
      Tenure: { min: 0, max: 10, label: "Tenure" },
      Balance: { min: 0, max: 300000, label: "Balance" },
      Product: { min: 1, max: 6, label: "Number of Products" },
      EstimatedSalary: {
        min: 5000,
        max: 3000000,
        label: "Estimated Salary",
      },
    };

    // Validate input values
    function validateInputs(data) {
      const errors = [];

      for (const [field, range] of Object.entries(validationRanges)) {
        const value = data[field];
        if (value < range.min || value > range.max) {
          errors.push(
            `丘멆잺 ${range.label}: Please enter a value between ${range.min} and ${range.max}. You entered: ${value}`,
          );
        }
      }

      return errors;
    }

    // Simple prediction simulation
    function simulatePrediction(data) {
      // Simple heuristic for demo
      let score = 0;

      // Age factor
      if (data.Age > 50) score += 20;
      else if (data.Age > 40) score += 15;

      // Tenure factor
      if (data.Tenure < 2) score += 25;
      else if (data.Tenure < 5) score += 15;

      // Balance factor
      if (data.Balance === 0) score += 15;

      // Product factor
      if (data.Product === 1) score += 10;

      // Credit score factor
      if (data.CreditScore < 600) score += 20;
      else if (data.CreditScore < 700) score += 10;

      // Active member factor
      if (data.IsActiveMember === 0) score += 20;

      // Add some randomness for demo
      score = Math.min(100, Math.max(0, score + (Math.random() * 10 - 5)));

      return Math.round(score);
    }

    function getRiskLevel(probability) {
      if (probability >= 70) return "High";
      if (probability >= 40) return "Medium";
      return "Low";
    }

    // Handle form submission
    document
      .getElementById("predictionForm")
      .addEventListener("submit", function (e) {
        e.preventDefault();

        const data = {
          CreditScore: parseFloat(
            document.getElementById("CreditScore").value,
          ),
          Age: parseFloat(document.getElementById("Age").value),
          Tenure: parseFloat(document.getElementById("Tenure").value),
          Balance: parseFloat(document.getElementById("Balance").value),
          Product: parseFloat(document.getElementById("Product").value),
          EstimatedSalary: parseFloat(
            document.getElementById("EstimatedSalary").value,
          ),
          Gender: document.getElementById("Gender").value,
          Country: document.getElementById("Country").value,
          HasCrCard: parseInt(document.getElementById("HasCrCard").value),
          IsActiveMember: parseInt(
            document.getElementById("IsActiveMember").value,
          ),
        };

        // Validate inputs
        const validationErrors = validateInputs(data);
        if (validationErrors.length > 0) {
          alert(
            "Please correct the following issues:\n\n" +
            validationErrors.join("\n"),
          );
          return;
        }

        // Use backend or local simulation
        if (USE_BACKEND) {
          makePredictionWithBackend(data);
        } else {
          makePredictionLocal(data);
        }
      });

    // Make prediction using backend API
    async function makePredictionWithBackend(data) {
      try {
        const formData = new FormData();
        formData.append("CreditScore", data.CreditScore);
        formData.append("Age", data.Age);
        formData.append("Tenure", data.Tenure);
        formData.append("Balance", data.Balance);
        formData.append("Product", data.Product);
        formData.append("EstimatedSalary", data.EstimatedSalary);
        formData.append("Gender", data.Gender);
        formData.append("Country", data.Country);
        formData.append("HasCrCard", data.HasCrCard);
        formData.append("IsActiveMember", data.IsActiveMember);

        const response = await fetch(`${BACKEND_URL}/predict`, {
          method: "POST",
          body: formData,
        });

        if (!response.ok) {
          throw new Error("Backend prediction failed");
        }

        const result = await response.json();
        displayPrediction(result.probability, result.risk);
      } catch (error) {
        console.error("Backend error:", error);
        alert(
          "Unable to connect to backend. Using local simulation instead.",
        );
        makePredictionLocal(data);
      }
    }

    // Make prediction using local simulation
    function makePredictionLocal(data) {
      const probability = simulatePrediction(data);
      const risk = getRiskLevel(probability);
      displayPrediction(probability, risk);
    }

    // Display prediction result
    function displayPrediction(probability, risk) {
      // Add to predictions
      predictions.push({ probability, risk });

      // Save to localStorage
      savePredictionsToStorage();

      // Update display
      document.getElementById("probabilityValue").textContent =
        probability + "%";

      const riskCard = document.getElementById("riskCard");
      const riskValue = document.getElementById("riskValue");

      // Remove previous classes
      riskCard.classList.remove("risk-high", "risk-medium", "risk-low");

      if (risk === "High") {
        riskCard.classList.add("risk-high");
        riskValue.textContent = "游댮 HIGH RISK";
      } else if (risk === "Medium") {
        riskCard.classList.add("risk-medium");
        riskValue.textContent = "游리 MEDIUM RISK";
      } else {
        riskCard.classList.add("risk-low");
        riskValue.textContent = "游릭 LOW RISK";
      }

      document.getElementById("predictionResult").style.display = "block";
      updateStats();

      // Scroll to stats
      document.getElementById("stats").scrollIntoView({ behavior: "smooth" });
    }

    // Handle Predict Another button
    document.addEventListener("DOMContentLoaded", function () {
      const predictAnotherBtn = document.getElementById("predictAnotherBtn");
      if (predictAnotherBtn) {
        predictAnotherBtn.addEventListener("click", function () {
          // Reset form
          document.getElementById("predictionForm").reset();
          // Scroll to predict section
          document
            .getElementById("predict")
            .scrollIntoView({ behavior: "smooth" });
          // Focus on first input
          document.getElementById("CreditScore").focus();
        });
      }
    });

    function updateStats() {
      const total = predictions.length;
      const high = predictions.filter((p) => p.risk === "High").length;
      const medium = predictions.filter((p) => p.risk === "Medium").length;
      const low = predictions.filter((p) => p.risk === "Low").length;

      document.getElementById("totalCount").textContent = total;
      document.getElementById("highCount").textContent = high;
      document.getElementById("mediumCount").textContent = medium;
      document.getElementById("lowCount").textContent = low;

      updateChart(high, medium, low);
    }

    function updateChart(high, medium, low) {
      const ctx = document.getElementById("riskChart").getContext("2d");

      const chartData = {
        labels: ["High Risk", "Medium Risk", "Low Risk"],
        datasets: [
          {
            label: "Churn Risk Distribution",
            data: [high, medium, low],
            borderWidth: 1,
            backgroundColor: [
              "rgba(220, 38, 38, 0.7)",
              "rgba(217, 119, 6, 0.7)",
              "rgba(34, 197, 94, 0.7)",
            ],
            borderColor: [
              "rgba(220, 38, 38, 1)",
              "rgba(217, 119, 6, 1)",
              "rgba(34, 197, 94, 1)",
            ],
          },
        ],
      };

      if (chartInstance) {
        chartInstance.data = chartData;
        chartInstance.update();
      } else {
        chartInstance = new Chart(ctx, {
          type: "bar",
          data: chartData,
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                labels: {
                  color: "#e2e8f0",
                },
              },
            },
            scales: {
              y: {
                ticks: {
                  color: "#e2e8f0",
                },
                grid: {
                  color: "rgba(56, 189, 248, 0.1)",
                },
              },
              x: {
                ticks: {
                  color: "#e2e8f0",
                },
                grid: {
                  color: "rgba(56, 189, 248, 0.1)",
                },
              },
            },
          },
        });
      }
    }

    // Initialize chart on page load
    window.addEventListener("load", function () {
      loadPredictionsFromStorage();
      updateStats();
      updateChart(
        predictions.filter((p) => p.risk === "High").length,
        predictions.filter((p) => p.risk === "Medium").length,
        predictions.filter((p) => p.risk === "Low").length,
      );
    });
  </script>
</body>

</html>